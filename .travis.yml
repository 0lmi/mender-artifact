language: go

# Disable git shallow clone. We need full history for validating copyright year of each file.
git:
    depth: false

# Golang version matrix
go:
    - 1.11

install:
    # Get tools used in Makefile
    - make get-tools

addons:
  apt:
    packages: mtools liblzma-dev

before_script:
    # Print build info.
    - echo $TRAVIS_COMMIT
    - echo $TRAVIS_TAG
    - echo $TRAVIS_BRANCH
    - echo $TRAVIS_BUILD_NUMBER
    - echo $TRAVIS_REPO_SLUG

    # Rename the branch we're on, so that it's not in the way for the
    # subsequent fetch. It's ok if this fails, it just means we're not on any
    # branch.
    - git branch -m temp-branch || true
    # Git trick: Fetch directly into our local branches instead of remote
    # branches.
    - git fetch origin 'refs/heads/*:refs/heads/*'
    # Get last remaining tags, if any.
    - git fetch --tags origin

jobs:
  include:
    - stage: build
      script:
          - make build
          - make extracheck
      os: linux
    - stage: build
      script: make build
      os: osx
    - stage: test
      script: true
      os: osx
    - stage: test
      script:
          - make coverage
          - make test
      os: linux

after_success:
    # Integrate with https://codecov.io
    - bash <(curl -s https://codecov.io/bash)
